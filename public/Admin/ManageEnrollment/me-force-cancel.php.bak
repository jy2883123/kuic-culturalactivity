<?php
/**
 * 관리자 강제 취소 처리
 * 관리자가 학생의 신청을 강제로 취소하고 이유를 기록
 */

require_once '../../../config/config_admin.php';

$admin_id = $_SESSION['admin_id'] ?? null;
$admin_name = $_SESSION['admin_name'] ?? null;

// POST 요청만 허용
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    header('Location: /Admin/ManageEnrollment/me-index.php');
    exit();
}

// CSRF 토큰 검증
$csrf_token = $_POST['csrf_token'] ?? '';
if (!csrf_validate_token($csrf_token)) {
    $_SESSION['me_error'] = '보안 토큰이 유효하지 않습니다. 다시 시도해주세요.';
    header('Location: /Admin/ManageEnrollment/me-index.php');
    exit();
}

try {
    $enrollment_id = isset($_POST['enrollment_id']) ? (int)$_POST['enrollment_id'] : 0;
    $admin_reason = trim($_POST['admin_reason'] ?? '');

    if ($enrollment_id <= 0) {
        throw new Exception('Invalid enrollment ID.');
    }

    if (empty($admin_reason)) {
        throw new Exception('Cancellation reason is required.');
    }

    // 트랜잭션 시작
    $pdo->beginTransaction();

    // 신청 정보 확인
    $enrollment_stmt = $pdo->prepare("
        SELECT e.*, ca.program_name, ca.activity_date
        FROM cultural_activity_enrollments e
        INNER JOIN cultural_activities ca ON e.activity_id = ca.id
        WHERE e.id = :enrollment_id
        LIMIT 1
    ");
    $enrollment_stmt->execute(['enrollment_id' => $enrollment_id]);
    $enrollment = $enrollment_stmt->fetch(PDO::FETCH_ASSOC);

    if (!$enrollment) {
        throw new Exception('Enrollment not found.');
    }

    if ($enrollment['status'] === 'cancelled') {
        throw new Exception('This enrollment has already been cancelled.');
    }

    if ($enrollment['status'] !== 'approved') {
        throw new Exception('Only approved enrollments can be cancelled.');
    }

    // 체크인 여부 확인 (체크인 완료된 경우 취소 불가)
    if (!empty($enrollment['checked_in']) && (int)$enrollment['checked_in'] === 1) {
        throw new Exception('Cannot cancel enrollment after check-in has been completed.');
    }

    // 활동 날짜 확인 (지난 이벤트는 취소 불가)
    $seoulTz = new DateTimeZone('Asia/Seoul');
    $now = new DateTime('now', $seoulTz);
    $activity_date = new DateTime($enrollment['activity_date'], $seoulTz);

    if ($activity_date < $now) {
        throw new Exception('Cannot cancel enrollment for past events.');
    }

    // 신청 상태를 'cancelled'로 업데이트 + 취소 정보 기록
    $cancel_stmt = $pdo->prepare("
        UPDATE cultural_activity_enrollments
        SET status = 'cancelled',
            cancelled_by = 'admin',
            admin_reason = :admin_reason
        WHERE id = :enrollment_id
    ");
    $cancel_stmt->execute([
        'enrollment_id' => $enrollment_id,
        'admin_reason' => $admin_reason
    ]);

    // IP 주소 추출 (Cloudflare 우선)
    $client_ip = null;
    if (!empty($_SERVER['HTTP_CF_CONNECTING_IP'])) {
        $client_ip = $_SERVER['HTTP_CF_CONNECTING_IP'];
    } elseif (!empty($_SERVER['HTTP_X_REAL_IP'])) {
        $client_ip = $_SERVER['HTTP_X_REAL_IP'];
    } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
        $forwarded = $_SERVER['HTTP_X_FORWARDED_FOR'];
        $client_ip = is_string($forwarded) && strpos($forwarded, ',') !== false
            ? trim(explode(',', $forwarded)[0])
            : $forwarded;
    } else {
        $client_ip = $_SERVER['REMOTE_ADDR'] ?? null;
    }

    // 취소 이력 기록
    $history_stmt = $pdo->prepare("
        INSERT INTO cultural_activity_enrollment_history
        (enrollment_id, student_id, student_name, activity_id, action, action_details, ip_address)
        VALUES (:enrollment_id, :student_id, :student_name, :activity_id, 'cancelled', :action_details, :ip_address)
    ");

    $action_details = json_encode([
        'cancelled_by' => 'admin',
        'admin_id' => $admin_id,
        'admin_name' => $admin_name,
        'reason' => $admin_reason
    ], JSON_UNESCAPED_UNICODE);

    $history_stmt->execute([
        'enrollment_id' => $enrollment_id,
        'student_id' => $enrollment['student_id'],
        'student_name' => $enrollment['student_name'],
        'activity_id' => $enrollment['activity_id'],
        'action_details' => $action_details,
        'ip_address' => $client_ip
    ]);

    // 활동의 current_enrollment 감소
    $update_count_stmt = $pdo->prepare("
        UPDATE cultural_activities
        SET current_enrollment = GREATEST(0, current_enrollment - 1)
        WHERE id = :activity_id
    ");
    $update_count_stmt->execute(['activity_id' => $enrollment['activity_id']]);

    // 관리자 로그 기록
    $log_stmt = $pdo->prepare("
        INSERT INTO cultural_activity_admin_logs (admin_id, activity_id, action, details, ip_address)
        VALUES (:admin_id, :activity_id, 'force_cancel_enrollment', :details, :ip_address)
    ");

    $log_details = json_encode([
        'enrollment_id' => $enrollment_id,
        'student_id' => $enrollment['student_id'],
        'student_name' => $enrollment['student_name'],
        'program_name' => $enrollment['program_name'],
        'reason' => $admin_reason,
        'admin_name' => $admin_name
    ], JSON_UNESCAPED_UNICODE);

    $log_stmt->execute([
        'admin_id' => $admin_id,
        'activity_id' => $enrollment['activity_id'],
        'details' => $log_details,
        'ip_address' => $client_ip
    ]);

    $pdo->commit();

    $_SESSION['me_success'] = 'Enrollment has been cancelled for ' . htmlspecialchars($enrollment['student_name'], ENT_QUOTES, 'UTF-8') . '.';
    header('Location: /Admin/ManageEnrollment/me-detail.php?id=' . $enrollment['activity_id']);
    exit();

} catch (Exception $e) {
    // 트랜잭션 롤백
    if (isset($pdo) && $pdo->inTransaction()) {
        $pdo->rollBack();
    }

    error_log('Force cancel error: ' . $e->getMessage());
    $_SESSION['me_error'] = $e->getMessage();

    if (isset($enrollment['activity_id'])) {
        header('Location: /Admin/ManageEnrollment/me-detail.php?id=' . $enrollment['activity_id']);
    } else {
        header('Location: /Admin/ManageEnrollment/me-index.php');
    }
    exit();
}
