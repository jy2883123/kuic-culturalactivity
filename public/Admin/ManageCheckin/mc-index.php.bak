<?php
define('ALLOW_CHECKIN_TOKEN', true);
require_once '../../../config/config_admin.php';

$admin_name = $_SESSION['admin_name'] ?? 'Administrator';
$admin_position = $_SESSION['admin_position'] ?? 'Admin';
$success_message = '';
$error_message = '';
$lookup_data = null;
$student_profile = null;
$selected_activity = isset($_POST['activity_id']) ? (int)$_POST['activity_id'] : 0;
$scan_value = trim($_POST['scan_value'] ?? '');
$action = $_POST['action'] ?? '';

try {
    $activities_stmt = $pdo->prepare("
        SELECT id, program_name, activity_date
        FROM cultural_activities
        WHERE is_deleted = FALSE
        ORDER BY activity_date ASC, program_name ASC
    ");
    $activities_stmt->execute();
    $activities = $activities_stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    $activities = [];
    $error_message = '활동 목록을 불러오지 못했습니다: ' . $e->getMessage();
}

function parse_scan_payload(string $payload): array {
    $decoded = base64_decode($payload, true);
    if ($decoded !== false && stripos($decoded, 'CA-CHECKIN') === 0) {
        $payload = $decoded;
    }

    // Expected format: CA-CHECKIN|ACT=123|STU=2025xxxx
    if (stripos($payload, 'CA-CHECKIN') === 0) {
        $parts = explode('|', $payload);
        $data = [];
        foreach ($parts as $part) {
            if (strpos($part, '=') !== false) {
                [$key, $value] = explode('=', $part, 2);
                $data[strtoupper(trim($key))] = trim($value);
            }
        }
        if (!empty($data['ACT']) && !empty($data['STU'])) {
            return [
                'activity_id' => (int)$data['ACT'],
                'student_id' => $data['STU'],
                'token' => $data['TOKEN'] ?? null
            ];
        }
    }
    // Treat fallback payload as direct student ID.
    return [
        'activity_id' => null,
        'student_id' => $payload,
        'token' => null
    ];
}

function expected_qr_token(array $activityRow, string $studentId): string {
    if (!empty($activityRow['qr_code'])) {
        return (string)$activityRow['qr_code'];
    }
    $activityId = $activityRow['activity_id'] ?? $activityRow['id'] ?? '';
    $seed = $activityId . '|' . $studentId . '|' . ($activityRow['program_name'] ?? '');
    return hash('sha256', $seed);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && in_array($action, ['lookup', 'checkin'], true)) {
    if ($selected_activity <= 0) {
        $error_message = '활동을 선택해주세요.';
    } elseif ($scan_value === '') {
        $error_message = 'QR 코드 또는 학생 정보를 입력해주세요.';
    } else {
        try {
            $parsed = parse_scan_payload($scan_value);
            $student_id = $parsed['student_id'];
            $qr_activity = $parsed['activity_id'];
            $qr_token = $parsed['token'];

            if ($qr_activity !== null && $qr_activity !== $selected_activity) {
                throw new Exception('QR 코드에 기록된 활동과 선택한 활동이 일치하지 않습니다.');
            }

            $enrollment_stmt = $pdo->prepare("
                SELECT
                    e.id AS enrollment_id,
                    e.student_id,
                    e.student_name,
                    e.status,
                    e.checked_in,
                    e.check_in_time,
                    ca.id AS activity_id,
                    ca.program_name,
                    ca.activity_date,
                    ca.activity_time,
                    ca.qr_code
                FROM cultural_activity_enrollments e
                INNER JOIN cultural_activities ca ON ca.id = e.activity_id
                WHERE e.activity_id = :activity_id
                  AND e.student_id = :student_id
                  AND e.status = 'approved'
                  AND ca.is_deleted = FALSE
                LIMIT 1
            ");
            $enrollment_stmt->execute([
                'activity_id' => $selected_activity,
                'student_id' => $student_id
            ]);
            $lookup_data = $enrollment_stmt->fetch(PDO::FETCH_ASSOC);

            if (!$lookup_data) {
                throw new Exception('해당 학생은 이 활동에 승인된 상태가 아닙니다.');
            }

            if ($qr_token !== null) {
                $expected_token = expected_qr_token($lookup_data, $lookup_data['student_id']);
                if (!hash_equals($expected_token, $qr_token)) {
                    throw new Exception('유효하지 않은 QR 코드입니다.');
                }
            }

            $profile_stmt = $pdo->prepare("
                SELECT applicant_name, email, birthdate
                FROM uwayxlsx_current
                WHERE application_no = :app_no
                LIMIT 1
            ");
            $profile_stmt->execute(['app_no' => $student_id]);
            $student_profile = $profile_stmt->fetch(PDO::FETCH_ASSOC) ?: [
                'applicant_name' => $lookup_data['student_name'],
                'email' => '',
                'birthdate' => ''
            ];

            if ($action === 'checkin') {
                if ((int)$lookup_data['checked_in'] === 1) {
                    throw new Exception('이미 출석 처리된 학생입니다.');
                }

                $pdo->beginTransaction();
                $update_stmt = $pdo->prepare("
                    UPDATE cultural_activity_enrollments
                    SET checked_in = 1, check_in_time = NOW()
                    WHERE id = :id
                ");
                $update_stmt->execute(['id' => $lookup_data['enrollment_id']]);

                $history_stmt = $pdo->prepare("
                    INSERT INTO cultural_activity_enrollment_history
                    (enrollment_id, student_id, student_name, activity_id, action, ip_address)
                    VALUES (:enrollment_id, :student_id, :student_name, :activity_id, 'checkin', :ip_address)
                ");
                $history_stmt->execute([
                    'enrollment_id' => $lookup_data['enrollment_id'],
                    'student_id' => $lookup_data['student_id'],
                    'student_name' => $lookup_data['student_name'],
                    'activity_id' => $selected_activity,
                    'ip_address' => $_SERVER['HTTP_CF_CONNECTING_IP'] ?? $_SERVER['HTTP_X_REAL_IP'] ?? $_SERVER['HTTP_X_FORWARDED_FOR'] ?? ($_SERVER['REMOTE_ADDR'] ?? '')
                ]);

                // 관리자 로그 기록
                $admin_id = $_SESSION['admin_id'] ?? 'unknown';
                $client_ip = $_SERVER['HTTP_CF_CONNECTING_IP'] ?? $_SERVER['HTTP_X_REAL_IP'] ?? $_SERVER['HTTP_X_FORWARDED_FOR'] ?? ($_SERVER['REMOTE_ADDR'] ?? null);
                if (is_string($client_ip) && strpos($client_ip, ',') !== false) {
                    $client_ip = trim(explode(',', $client_ip)[0]);
                }

                $log_stmt = $pdo->prepare("
                    INSERT INTO cultural_activity_admin_logs (admin_id, activity_id, action, details, ip_address)
                    VALUES (:admin_id, :activity_id, 'manual_checkin', :details, :ip_address)
                ");
                $log_stmt->execute([
                    'admin_id' => $admin_id,
                    'activity_id' => $selected_activity,
                    'details' => json_encode([
                        'enrollment_id' => $lookup_data['enrollment_id'],
                        'student_id' => $lookup_data['student_id'],
                        'student_name' => $lookup_data['student_name']
                    ], JSON_UNESCAPED_UNICODE),
                    'ip_address' => $client_ip
                ]);

                $pdo->commit();

                $success_message = '출석이 완료되었습니다.';
                $lookup_data['checked_in'] = 1;
                $lookup_data['check_in_time'] = date('Y-m-d H:i:s');
            }

        } catch (Exception $e) {
            if ($pdo->inTransaction()) {
                $pdo->rollBack();
            }
            $error_message = $e->getMessage();
            $lookup_data = null;
            $student_profile = null;
        }
    }
}
?>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>체크인 관리 | <?= htmlspecialchars($PAGE_NAME, ENT_QUOTES, 'UTF-8') ?></title>
    <style>
        :root {
            --admin-primary: #1e40af;
            --admin-accent: #3b82f6;
            --bg-soft: #f6f8fb;
            --border-color: #d1dce8;
            --text-main: #1f2933;
            --text-muted: #6b7280;
            --success-green: #16a34a;
            --warning-orange: #ea580c;
            --error-red: #dc2626;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { min-height: 100vh; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif; background: var(--bg-soft); color: var(--text-main); }
        .container { min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, var(--admin-primary), var(--admin-accent)); color: #fff; padding: 20px 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.2s ease;
        }
        .back-btn:hover { background: rgba(255,255,255,0.35); }
        .header-title h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 2px; }
        .header-subtitle { font-size: 0.85rem; opacity: 0.9; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .admin-badge { padding: 6px 14px; background: rgba(255,255,255,0.25); border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .btn-logout { padding: 8px 20px; background: rgba(255,255,255,0.95); color: var(--admin-primary); border-radius: 8px; text-decoration: none; font-weight: 600; }
        .main-content { flex: 1; max-width: 1100px; margin: 0 auto; width: 100%; padding: 32px 24px 48px; }
        .page-header { margin-bottom: 24px; }
        .page-title { font-size: 1.8rem; font-weight: 700; color: var(--admin-primary); margin-bottom: 8px; }
        .page-description { color: var(--text-muted); line-height: 1.5; }
        .alert { padding: 12px 16px; border-radius: 10px; margin-bottom: 20px; }
        .alert-success { background: #dcfce7; color: var(--success-green); }
        .alert-error { background: #fee2e2; color: var(--error-red); }
        .card { background: #fff; border-radius: 18px; padding: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); margin-bottom: 24px; }
        label { font-weight: 600; display: block; margin-bottom: 6px; }
        select, input[type="text"] { width: 100%; border-radius: 10px; border: 1px solid var(--border-color); padding: 10px 12px; font-size: 0.95rem; }
        .actions { margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap; }
        .btn-primary { padding: 10px 18px; border-radius: 10px; border: none; background: linear-gradient(135deg, #1a5490, #2563eb); color: #fff; font-weight: 600; cursor: pointer; }
        .btn-secondary { padding: 10px 18px; border-radius: 10px; border: 1px solid var(--border-color); background: #fff; color: var(--text-main); font-weight: 600; cursor: pointer; }
        .lookup-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-top: 16px; }
        .info-box { background: #f9fafb; border-radius: 12px; padding: 16px; border: 1px solid #e5e7eb; }
        .info-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); margin-bottom: 4px; }
        .info-value { font-size: 1rem; font-weight: 600; }
        .footer { background: #fff; border-top: 1px solid var(--border-color); padding: 20px 32px; text-align: center; color: var(--text-muted); font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <a href="/Admin/dashboard.php" class="back-btn">← 대시보드</a>
                    <div>
                        <h1>체크인 관리</h1>
                        <div class="header-subtitle">선택한 활동에서 QR/학번으로 출석을 처리합니다.</div>
                    </div>
                </div>
                <div class="header-right">
                    <span class="admin-badge"><?= htmlspecialchars($admin_position, ENT_QUOTES, 'UTF-8') ?></span>
                    <a href="/Auth/admin_logout.php" class="btn-logout">로그아웃</a>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">빠른 체크인</h2>
                <p class="page-description">QR 코드를 계속 스캔하거나 예외 상황에서는 학번을 수동으로 입력해 출석을 처리하세요.</p>
            </div>

            <?php if ($success_message): ?><div class="alert alert-success"><?= htmlspecialchars($success_message, ENT_QUOTES, 'UTF-8') ?></div><?php endif; ?>
            <?php if ($error_message): ?><div class="alert alert-error"><?= htmlspecialchars($error_message, ENT_QUOTES, 'UTF-8') ?></div><?php endif; ?>

            <section class="card">
                <form method="POST">
                    <label for="activity_id">활동 선택</label>
                    <select id="activity_id" name="activity_id" required>
                        <option value="">-- Select activity --</option>
                        <?php foreach ($activities as $activity): ?>
                            <?php $label = $activity['program_name'] . ' (' . date('m/d', strtotime($activity['activity_date'])) . ')'; ?>
                            <option value="<?= $activity['id'] ?>" <?= $selected_activity == $activity['id'] ? 'selected' : '' ?>>
                                <?= htmlspecialchars($label, ENT_QUOTES, 'UTF-8') ?>
                            </option>
                        <?php endforeach; ?>
                    </select>

                    <label for="scan_value" style="margin-top:14px;">QR 코드 / 학번 입력</label>
                    <input type="text" id="scan_value" name="scan_value" value="<?= htmlspecialchars($scan_value, ENT_QUOTES, 'UTF-8') ?>" placeholder="CA-CHECKIN|ACT=123|STU=2025xxxx|TOKEN=..." required />

                    <div class="actions">
                        <button type="submit" name="action" value="lookup" class="btn-secondary">학생 조회</button>
                        <button type="submit" name="action" value="checkin" class="btn-primary">출석 처리</button>
                    </div>
                </form>
            </section>

            <?php if ($lookup_data): ?>
                <section class="card">
                    <h3 style="margin-bottom:12px;">학생 정보 확인</h3>
                    <div class="lookup-grid">
                        <div class="info-box">
                            <div class="info-label">학생 이름</div>
                            <div class="info-value"><?= htmlspecialchars($lookup_data['student_name'], ENT_QUOTES, 'UTF-8') ?></div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">학번</div>
                            <div class="info-value"><?= htmlspecialchars($lookup_data['student_id'], ENT_QUOTES, 'UTF-8') ?></div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">생년월일</div>
                            <div class="info-value"><?= htmlspecialchars($student_profile['birthdate'] ?? 'N/A', ENT_QUOTES, 'UTF-8') ?></div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">이메일</div>
                            <div class="info-value"><?= htmlspecialchars($student_profile['email'] ?? 'N/A', ENT_QUOTES, 'UTF-8') ?></div>
                        </div>
                        <div class="info-box">
                            <div class="info-label">현재 상태</div>
                            <div class="info-value"><?= $lookup_data['checked_in'] ? 'Checked-in' : 'Pending' ?></div>
                        </div>
                    </div>
                    <?php if ($lookup_data['checked_in'] && $lookup_data['check_in_time']): ?>
                        <p style="margin-top:12px; color: var(--success-green);">출석 완료 시간: <?= htmlspecialchars(date('Y-m-d H:i', strtotime($lookup_data['check_in_time'])), ENT_QUOTES, 'UTF-8') ?></p>
                    <?php endif; ?>
                </section>
            <?php endif; ?>
        </main>

        <footer class="footer">
            © DATANEST, KOREA UNIVERSITY – Int'l Summer &amp; Winter Campus
        </footer>
    </div>
</body>
</html>
